# 事务

## 事务概念

### 事务

事务是数据库操作最基本单元，逻辑上的一组操作。要么都成功，如果有一个失败所有操作都失败。

典型场景：银行转账。



### 事务的四大特性

1. 原子性：一个事务是一个不可分割的工作单位，事务中包括的操作要么都做，要么都不做。
2. 一致性：事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。
3. 隔离性：一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
4. 持久性：持久性也称永久性，指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。



### 搭建事务操作环境

1. 创建数据库表，添加记录
2. 创建service、dao，完成对象创建和注入操作
   1. service中注入dao；dao中注入JdbcTemplate；JdbcTemplate中注入DataSource
3. 在dao中创建两个方法：多钱和少钱的方法，在service中创建转账的方法
4. 测试



### Spring事务管理

1. 事务添加到Service层（业务逻辑层）
2. Spring中进行事务管理操作
   1. 编程式事务管理
   2. 声明式事务管理（使用）
3. 声明式事务管理
   1. 基于注解方式（使用）
   2. 基于xml配置文件方式
4. 在Spring进行声明式事务管理，底层使用AOP原理
5. Spring事务管理API
   1. 使用PlatformTransactionManager接口，它代表事务管理器，这个接口针对不同的框架提供不同的实现类
   2. 使用DataSourceTransactionManager这个接口的实现类实现事务管理。



### 注解方式实现声明式事务管理

1. 在spring配置文件中配置事务管理器
2. 在spring配置文件中开启事务注解，指定事务管理器
   1. 在spring配置文件中引入命名空间tx
   2. 开启事务注解，指定事务管理器
3. 在service类上面（或者service类里面方法上面）添加事务注解**@Transactional**
   1. @Transactional这个注解可以添加到类上面，也可以添加到方法上面
   2. 如果把这个注解添加到类上面，这个类里面所有的方法都添加事务
   3. 如果把这个注解添加到方法上面，为这个方法添加事务



### @Transactional参数说明

1. propagation：事务传播行为
   1. 多事务方法之间直接调用，这个过程中事务是如何管理的
   2. 事务方法：对数据库表中数据变化操作的方法 
   3. REQUIRED：如果有事务在运行，当前的方法就在这个事务内运行，否则就启动一个新的事务，并在自己的事务内运行
   4. REQUIRED_NEW：当前的方法必须启动新事务，并在自己的事务内运行，如果有事务正在运行，应该将它挂起
2. ioslation：事务隔离级别
   1. 事务有隔离性，多事务操作之间不会产生影响。
   2. 不考虑隔离性会出现三个读问题：脏读、不可重复读、幻读
   3. 脏读：一个未提交的事务读取到另一个未提交事务的数据
   4. 不可重复读：一个未提交事务读取到另一个提交事务修改的数据
   5. 幻读：一个未提交事务读取到另一个提交事务提交的事务
   6. 通过设置事务隔离级别，解决读问题
   7. mysql中默认设置为：REPEATABLE READ（可重复读）
3. timeout：超时时间
   1. 事务需要在一定时间内进行提交，如果不提交则进行回滚
   2. 默认值为-1，设置时间以秒为单位进行计算
4. readOnly：是否只读
   1. readOnly默认值为false，表示可以查询，可以添加修改删除操作
   2. 设置为true后，只能查询
5. rollbackFor：回滚
   1. 设置出现哪些异常后进行事务回滚
6. norollbackFor：不会滚
   1. 设置出现哪些异常后不进行事务回滚



### XML方式实现声明式事务管理

1. 在spring配置文件中进行配置
   1. 配置事务管理器
   2. 配置通知
   3. 配置切入点和切面



### 完全注解实现声明式事务管理

1. 创建配置类，使用配置类代替xml配置文件






